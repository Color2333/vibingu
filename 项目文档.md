这份文档是 **Project Vibing u** 的核心架构书。

整个系统的起点是要做一个早睡早起的打卡器！

既然我们升级了愿景，从单一的睡眠管理转向了全维度的生活数据化，**Vibing u** 将不再只是一个工具，而是你个人的 **"数字人生黑匣子" (Digital Life Black Box)**。

---

# 📁 Project: Vibing u

**Slogan:** Digitize Your Vibe. Optimize Your Life.
**中文愿景：** 建立个人的生活数据集，用 AI 寻找"最佳状态"的源代码。

---

### 1. 核心哲学 (Core Philosophy)

* **Everything is Data (万物皆数据):** 睡眠截图是数据，一杯冰美式是数据，窗外的雨天是数据，一句吐槽也是数据。
* **The Long Game (持久战):** 我们不追求短期的打卡，而是建立一个长期的、私有的 **"Life Dataset"**。随着数据量的积累，AI 将能揭示你自己都不知道的行为模式。
* **Vibe Check (状态量化):** 将抽象的"状态好/不好"，量化为可追踪的 **"Vibing Index" (状态指数)**。

---

### 2. 产品交互逻辑 (User Experience Loop)

我们将交互极简化，核心只有一个动作：**Feed the AI (投喂)**。

#### 🟢 输入层：多模态投喂 (The Feed)

在网站主页设置一个 **"Magic Input Bar"**，支持三种核心输入：

1. **📸 Snap (拍)：**
* **场景 1：** 起床 -> 拍《小米运动睡眠截图》 -> **AI 解析：** 睡眠质量。
* **场景 2：** 睡前 -> 拍《屏幕使用时间》 -> **AI 解析：** 熬夜原因/数字压力。
* **场景 3：** 吃饭/喝水 -> 拍食物 -> **AI 解析：** 热量、咖啡因、糖分、是否罪恶餐。
* **场景 4：** 看到风景/工作台 -> 拍环境 -> **AI 解析：** 当前所处情境 (Context)。


2. **🗣️ Say (说)：**
* **场景：** 刚健完身，或者心里很烦。
* **动作：** 点击麦克风或输入文字："今天跑了5公里，膝盖有点疼，但心情巨爽。"
* **AI 解析：** 提取运动数据、情绪正负值。


3. **🔢 Log (记)：**
* **场景：** 记录体重、心率或其他具体数值。



#### 🔵 处理层：AI 语义工厂 (The Factory)

后台的 AI (GPT-4o Vision) 充当"全能翻译官"。它不只是识别图片，而是提取**结构化数据**。

* *输入：* 一张星巴克冰美式的照片。
* *输出存库：* `{"type": "drink", "item": "Iced Americano", "caffeine": 150mg, "time": "14:30", "tags": ["Focus", "Stimulant"]}`

#### 🟣 输出层：Vibing 反馈 (The Insight)

1. **Vibing Index (状态指数)：** 类似于之前的"身体股价"，综合睡眠、饮食、情绪计算出的实时分数。
2. **Correlation Alerts (关联警报)：**
* "注意：检测到你刚喝了奶茶（16:00），根据你的历史数据集，这会导致你今晚入睡时间推迟 45 分钟。"


3. **The Life Dashboard (人生仪表盘)：** 可视化展示你的生活流。

---

### 3. 数据库架构设计 (Database Schema)

这是"持久战"的基石。我们要设计一个能容纳未来的通用结构。推荐使用 **PostgreSQL (with JSONB)**。

#### 表 1: `daily_summary` (每日状态总表)

*每一天生成的"切片"，用于宏观分析。*

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| `date` | Date (PK) | 日期 (2023-10-27) |
| `wake_time` | Timestamp | 起床时间 |
| `bed_time` | Timestamp | 入睡时间 |
| `sleep_duration` | Float | 睡眠时长 (小时) |
| `screen_time` | Float | 屏幕总时长 (小时) |
| `vibe_score` | Integer | 当日 Vibing 指数 (0-100) |
| `energy_level` | Integer | 主观能量值 (1-10) |
| `daily_summary_text` | Text | AI 生成的当天日记摘要 |

#### 表 2: `life_stream` (全维生活流表)

*这是最核心的"数据集"表，存储所有的照片、对话、记录。*

| 字段名 | 类型 | 关键说明 |
| --- | --- | --- |
| `id` | UUID | 唯一标识 |
| `user_id` | UUID | 用户ID (为未来多用户预留) |
| `created_at` | Timestamp | 发生时间 |
| `input_type` | Enum | `IMAGE`, `TEXT`, `AUDIO`, `SCREENSHOT` |
| `category` | Enum | `SLEEP`, `DIET` (饮食), `SCREEN` (屏幕), `ACTIVITY` (活动), `MOOD` (情绪) |
| `raw_content` | Text | 文字内容 或 图片URL |
| **`meta_data`** | **JSONB** | **核心字段！存 AI 解析后的所有细节** |
| `ai_insight` | Text | AI 当时给出的一句话点评 |

**💡 `meta_data` JSONB 存储示例：**

* **饮食记录：** `{"food_name": "Burger", "calories": 600, "is_healthy": false, "tags": ["CheatMeal"]}`
* **睡眠截图：** `{"deep_sleep": "1h20m", "sleep_score": 85, "app_source": "MiFitness"}`

---

### 4. AI Prompt 策略 (The Soul)

为了让 **Vibing u** 懂你，我们需要设计一套分层的 Prompt 系统。

* **Role (人设):** 你是 Vibing u 的首席分析师。你冷静、客观，但极具洞察力。你的目标是通过数据帮助用户达到 "High Vibe" 状态。
* **Task (任务):**
1. **ETL:** 从用户上传的混乱信息（照片/文本）中提取 JSON 数据。
2. **Analysis:** 对比历史数据（我们将把最近 5 条相关记录塞进 Context），寻找规律。
3. **Feedback:** 用简短、犀利的语言给出建议。



**Prompt 示例 (饮食分析):**

> "用户上传了一张照片。
> 1. 识别这是什么食物/饮料。
> 2. 估算其中的咖啡因、糖分、大致热量。
> 3. 获取当前时间 ({current_time})。
> 4. 判断：在这个时间点摄入该物质，对今晚睡眠可能造成的影响。
> 5. 输出为 JSON 格式，并附带一条简短的中文建议 (key: `reply_text`)."
> 
> 

---

### 5. 功能开发路线图 (Roadmap)

我们分三步走，先把**数据集**建立起来。

#### Phase 1: The Recorder (记录者) - *已完成*

* **目标：** 让"投喂"变得极其顺滑。
* **功能：**
* Web 界面搭建 (Next.js)。
* 实现通用的"上传+文本"输入框。
* 接入 GPT-4o Vision，实现对"睡眠截图"和"饮食照片"的基础解析。
* 数据存入 PostgreSQL。


* **体验：** 你每天发照片给它，它回复你："记下来了，这杯咖啡含 150mg 咖啡因。"

#### Phase 2: The Analyst (分析师)

* **目标：** 让数据产生关联。
* **功能：**
* Vibing Index 算法实现（把睡眠、饮食、屏幕时长加权计算）。
* 首页仪表盘开发（展示 K 线图和今日状态）。
* 引入"关联分析"：当检测到晚睡时，自动查询当天是否喝了咖啡或玩了太久手机。



#### Phase 3: The Optimizer (优化者)

* **目标：** 主动干预。
* **功能：**
* App 化 (PWA / Native)。
* 主动推送：下午 2 点提醒"该喝水了"，晚上 10 点提醒"放下手机"。
* 长期报告：生成《2026 年度个人生活白皮书》。



---

### 6. 技术栈确认 (Tech Stack)

* **Domain:** (已就绪)
* **Server:** 云服务器 (已就绪)
* **Frontend:** Next.js + Tailwind CSS 
* **Backend:** Python FastAPI (处理 AI 逻辑)
* **Database:** PostgreSQL (带 JSONB 支持)
* **AI:** OpenAI GPT-4o API (处理多模态)

---

这套方案将 **Vibing u** 定义为一个**"生活伴侣"**而非简单的"管家"。它不评判你的生活，它只是记录、分析，并试图让你达到更好的频率 (Vibe)。

---

### 7. 本地开发指南 (Local Development Guide)

#### 7.1 环境要求

* Node.js 18+
* Python 3.11+
* Docker Desktop
* OpenAI API Key

#### 7.2 项目结构

```
BioClock/
├── 项目文档.md              # 产品设计文档
├── README.md               # 开发文档
├── docker-compose.yml      # Docker 服务编排
├── .env.example            # 环境变量模板
├── .gitignore
│
├── frontend/               # Next.js 前端
│   ├── package.json
│   ├── app/
│   │   ├── layout.tsx
│   │   ├── page.tsx        # 主页 Magic Input Bar
│   │   └── globals.css
│   └── components/
│       ├── MagicInputBar.tsx   # 多模态输入组件
│       ├── FeedHistory.tsx     # 历史记录展示
│       └── VibingCard.tsx      # 状态卡片
│
└── backend/                # FastAPI 后端
    ├── pyproject.toml      # Poetry 依赖管理
    ├── alembic.ini         # 数据库迁移配置
    ├── app/
    │   ├── main.py         # FastAPI 入口
    │   ├── config.py       # 配置管理
    │   ├── database.py     # 数据库连接
    │   ├── models/         # SQLAlchemy 模型
    │   ├── routers/        # API 路由
    │   ├── schemas/        # Pydantic 模型
    │   └── services/       # 业务逻辑 (AI 解析)
    └── alembic/            # 数据库迁移
```

#### 7.3 快速启动

**Step 1: 配置环境变量**

```bash
cp .env.example .env
# 编辑 .env，填入你的 OpenAI API Key
```

**Step 2: 启动数据库**

```bash
docker-compose up -d
```

**Step 3: 启动后端**

```bash
cd backend
poetry install
poetry run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**Step 4: 启动前端**

```bash
cd frontend
npm install
npm run dev
```

访问 http://localhost:3000 开始使用！

#### 7.4 API 接口规范

| 端点 | 方法 | 功能 | 参数 |
| --- | --- | --- | --- |
| `/api/feed` | POST | 多模态投喂 | `text` (文本), `image` (文件), `category_hint` (分类提示) |
| `/api/feed/history` | GET | 获取历史记录 | `limit`, `offset`, `category` |
| `/api/daily/{date}` | GET | 获取某日汇总 | `date` (YYYY-MM-DD) |
| `/health` | GET | 健康检查 | - |

#### 7.5 数据库迁移

```bash
cd backend

# 生成新的迁移
poetry run alembic revision --autogenerate -m "描述"

# 执行迁移
poetry run alembic upgrade head

# 回滚迁移
poetry run alembic downgrade -1
```

#### 7.6 环境变量说明

| 变量名 | 说明 | 默认值 |
| --- | --- | --- |
| `POSTGRES_USER` | 数据库用户名 | vibingu |
| `POSTGRES_PASSWORD` | 数据库密码 | vibingu_secret |
| `POSTGRES_DB` | 数据库名 | vibingu |
| `POSTGRES_HOST` | 数据库主机 | localhost |
| `POSTGRES_PORT` | 数据库端口 | 5432 |
| `OPENAI_API_KEY` | OpenAI API 密钥 | (必填) |
| `DEBUG` | 调试模式 | true |

---

### 8. Phase 1 完成状态

Phase 1 "The Recorder" 已完成核心功能：

- [x] Web 界面搭建 (Next.js + Tailwind CSS)
- [x] Magic Input Bar - 支持文本、图片、语音输入
- [x] GPT-4o Vision 集成 - 多模态解析
- [x] PostgreSQL/SQLite 数据存储 - JSONB 支持
- [x] 历史记录展示 - 分类筛选、时间线
- [x] Vibing Card - 每日状态概览

---

### 9. Phase 2 完成状态

Phase 2 "The Analyst" 已完成核心功能：

- [x] Vibing Index 算法实现 - 综合睡眠、饮食、屏幕、活动四维度计算
- [x] 每日数据聚合服务 - 自动更新 daily_summary
- [x] 关联分析功能 - 咖啡因/屏幕时间与睡眠的关联
- [x] 趋势图可视化 - 最近 7 天 Vibing Index 变化
- [x] 增强仪表盘 - 显示各维度分数和 AI 洞察

**新增 API 端点:**

| 端点 | 方法 | 功能 |
| --- | --- | --- |
| `/api/analytics/vibe/today` | GET | 获取今日 Vibing Index |
| `/api/analytics/vibe/{date}` | GET | 获取指定日期的 Vibing Index |
| `/api/analytics/trend` | GET | 获取最近 N 天趋势数据 |
| `/api/analytics/correlation` | GET | 获取关联分析结果 |

**Vibing Index 算法权重:**
- 睡眠: 40%
- 饮食: 25%
- 屏幕时间: 20%
- 活动量: 15%

---

### 10. Phase 3 完成状态

Phase 3 "The Optimizer" 已完成核心功能：

- [x] PWA 支持 - manifest.json、Service Worker、离线缓存
- [x] 提醒系统 - 喝水、休息、睡眠定时提醒
- [x] 周报/月报 - 周期性生活数据报告
- [x] 智能建议 - 基于历史数据的个性化建议
- [x] 数据导出 - 支持 JSON/CSV 格式导出

**新增 API 端点:**

| 端点 | 方法 | 功能 |
| --- | --- | --- |
| `/api/reports/weekly` | GET | 获取周报 |
| `/api/reports/monthly` | GET | 获取月报 |
| `/api/reports/suggestions` | GET | 获取智能建议 |
| `/api/reports/export` | GET | 导出数据 (JSON/CSV) |

**PWA 功能:**
- 可添加到主屏幕
- 离线访问支持
- 推送通知能力
- 原生应用体验

---

### 11. 公开展示页面

作为个人项目，新增了只读的公开展示页面 `/public`：

**访问地址:** http://localhost:3000/public

**特性:**
- 深色主题，沉浸式展示
- 实时显示今日 Vibe 分数
- 四维度生活数据展示
- 14 天趋势图
- 本周小结
- 自动每 5 分钟刷新

**页面结构:**
- **Admin 页面** (`/`) - 私人管理，用于记录数据
- **Public 页面** (`/public`) - 公开展示，只读访问

**下一步可扩展:**
- [ ] 年度个人生活白皮书
- [ ] 更多可视化图表
- [ ] 里程碑展示
